# =========================================
# üåç TravelMundo IA - Cloud Build (API Node v3.1.1)
# Deploy autom√°tico no Cloud Run (regi√£o: us-west1)
# Com rollback autom√°tico em caso de falha
# =========================================

steps:
  # üß© 1Ô∏è‚É£ Instalar depend√™ncias
  - name: 'gcr.io/cloud-builders/npm'
    dir: '.'
    args: ['install']
    id: 'Instalar Depend√™ncias'

  # üß™ 2Ô∏è‚É£ Log de ambiente e diagn√≥stico
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: bash
    args:
      - -c
      - |
        echo "üîç Vers√£o Node:"
        node -v
        echo "üîç Vari√°veis de ambiente:"
        echo "HOTMART_SECRET=${_HOTMART_SECRET}"
        echo "NODE_ENV=${_NODE_ENV}"
        echo "üßæ Data de build: $(date)"

  # üöÄ 3Ô∏è‚É£ Build da imagem Docker e push para Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    dir: '.'
    args:
      [
        'build',
        '-t',
        'us-west1-docker.pkg.dev/$PROJECT_ID/travelmundo-api/travelmundo-api:latest',
        '.'
      ]
    id: 'Build Docker'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'push',
        'us-west1-docker.pkg.dev/$PROJECT_ID/travelmundo-api/travelmundo-api:latest'
      ]
    id: 'Push Docker'

  # ‚öôÔ∏è 4Ô∏è‚É£ Deploy principal no Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run',
        'deploy',
        'travelmundo-api',
        '--image',
        'us-west1-docker.pkg.dev/$PROJECT_ID/travelmundo-api/travelmundo-api:latest',
        '--region',
        'us-west1',
        '--platform',
        'managed',
        '--allow-unauthenticated',
        '--memory',
        '512Mi',
        '--port',
        '8080',
        '--timeout',
        '300',
        '--set-env-vars',
        'NODE_ENV=${_NODE_ENV},HOTMART_SECRET=${_HOTMART_SECRET}'
      ]
    id: 'Deploy Cloud Run'

  # üõë 5Ô∏è‚É£ Rollback autom√°tico se o deploy falhar
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        echo "‚ö†Ô∏è Verificando status do √∫ltimo deploy..."
        LAST_REVISION=$(gcloud run revisions list \
          --service=travelmundo-api \
          --region=us-west1 \
          --format='value(METADATA.name)' \
          --limit=1)
        echo "√öltima revis√£o ativa: $LAST_REVISION"
        if [ -z "$LAST_REVISION" ]; then
          echo "‚ùå Nenhuma revis√£o anterior encontrada. Rollback cancelado."
          exit 0
        fi
        echo "‚è™ Restaurando revis√£o anterior..."
        gcloud run services update-traffic travelmundo-api \
          --region=us-west1 \
          --to-revisions=$LAST_REVISION=100
        echo "‚úÖ Rollback conclu√≠do: servi√ßo restaurado para $LAST_REVISION"
    id: 'Rollback Autom√°tico'
    waitFor:
      - 'Deploy Cloud Run'
    # Rollback s√≥ executa se o deploy falhar
    allowFailure: true

# ===============================
# üîê Permiss√µes & Configura√ß√µes
# ===============================
serviceAccount: 'travelmundo-api-sa@gen-lang-client-0394942372.iam.gserviceaccount.com'

timeout: 900s
options:
  logging: CLOUD_LOGGING_ONLY

# ===============================
# üß© Substitui√ß√µes configur√°veis
# ===============================
substitutions:
  _NODE_ENV: "production"
  _HOTMART_SECRET: "TMIA_3v1_SECRET_2025"
