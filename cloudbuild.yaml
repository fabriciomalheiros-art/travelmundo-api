# ============================================================
# üåç TravelMundo IA - Cloud Build (v3.1.4)
# Deploy autom√°tico no Cloud Run (us-west1)
# Compat√≠vel com Gatilhos e Execu√ß√µes Manuais ‚úÖ
# ============================================================

substitutions:
  _SERVICE_NAME: "travelmundo-api"
  _REGION: "us-west1"
  _VERSION: "3.1.4"

steps:
  # üß© 1Ô∏è‚É£ Instalar depend√™ncias
  - name: "gcr.io/cloud-builders/npm"
    args: ["install"]

  # üöÄ 2Ô∏è‚É£ Build da imagem Docker com tag de vers√£o
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest",
        "-t",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:${_VERSION}",
        "."
      ]

  # üì§ 3Ô∏è‚É£ Envia imagem para o Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest"
      ]

  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:${_VERSION}"
      ]

  # ‚òÅÔ∏è 4Ô∏è‚É£ Deploy no Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "${_SERVICE_NAME}",
        "--image",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest",
        "--region",
        "${_REGION}",
        "--platform",
        "managed",
        "--allow-unauthenticated",
        "--memory",
        "512Mi",
        "--port",
        "8080",
        "--set-env-vars",
        "NODE_ENV=production,HOTMART_SECRET=TMIA_3v1_SECRET_2025"
      ]

# üîê Conta de servi√ßo usada para o deploy
serviceAccount: "travelmundo-api-sa@gen-lang-client-0394942372.iam.gserviceaccount.com"

# ‚è±Ô∏è Tempo m√°ximo e destino dos logs
timeout: 900s
options:
  logging: CLOUD_LOGGING_ONLY
