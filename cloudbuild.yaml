# ============================================================
# üåç TravelMundo IA - Cloud Build (v3.1.8)
# ‚úÖ Compat√≠vel com Cloud SDK 472+ (substitui --mount ‚Üí --add-volume)
# ============================================================

substitutions:
  _SERVICE_NAME: "travelmundo-api"
  _REGION: "us-west1"

steps:
  # üß© 1Ô∏è‚É£ Instalar depend√™ncias
  - name: "gcr.io/cloud-builders/npm"
    args: ["install"]

  # üöÄ 2Ô∏è‚É£ Build da imagem Docker
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest",
        "."
      ]

  # üì§ 3Ô∏è‚É£ Envia imagem ao Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest"
      ]

  # ‚òÅÔ∏è 4Ô∏è‚É£ Deploy no Cloud Run (sintaxe nova)
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "${_SERVICE_NAME}",
        "--image",
        "us-west1-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest",
        "--region",
        "${_REGION}",
        "--platform",
        "managed",
        "--allow-unauthenticated",
        "--memory",
        "512Mi",
        "--port",
        "8080",

        # üîπ Vari√°veis de ambiente persistentes
        "--set-env-vars",
        "NODE_ENV=production,HOTMART_SECRET=y4GJWDRbL1IXEOwXRwWN2G0GyQKkPJ22417386,GOOGLE_APPLICATION_CREDENTIALS=/etc/secrets/firebase-service-account",

        # üîπ Montagem segura do Secret Firebase (nova sintaxe)
        "--add-volume",
        "name=firebase-key,secret=projects/$PROJECT_ID/secrets/firebase-service-account",
        "--add-volume-mount",
        "volume=firebase-key,mount-path=/etc/secrets"
      ]

# üîê Conta de servi√ßo usada para o deploy
serviceAccount: "travelmundo-api-sa@gen-lang-client-0394942372.iam.gserviceaccount.com"

timeout: 900s
options:
  logging: CLOUD_LOGGING_ONLY
